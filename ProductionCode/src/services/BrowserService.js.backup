/**
 * üåê Sovereign Browser Service
 * ============================
 *
 * Provides a robust, in-house capability for agents to browse the web.
 * It uses Puppeteer to control a headless Chromium instance, allowing agents to
 * read articles, scrape data, and interact with web pages programmatically.
 *
 * This service is a core component of our sovereign AI architecture.
 */
import puppeteer from 'puppeteer';
import { ollamaIntegration } from '../llm/OllamaIntegration.js';

// üß† FORMAL REASONING & VERIFICATION INTEGRATION (SPECIALIZED FOR BROWSER SERVICE)
import { FormalReasoningCognitiveIntegration } from '../../legendary-arbitrage-syndicate/packages/@syndicate/core/src/safety/cognitive/FormalReasoningCognitiveIntegration.js';

// üõ°Ô∏è PROACTIVE PREVENTION SYSTEMS INTEGRATION (SPECIALIZED FOR BROWSER SERVICE)
import { ProactiveKnowledgeCredibilityPipeline } from '../../legendary-arbitrage-syndicate/packages/@syndicate/core/src/prevention/ProactiveKnowledgeCredibilityPipeline.js';
import { ProactiveInferenceReliabilityEngine } from '../../legendary-arbitrage-syndicate/packages/@syndicate/core/src/prevention/ProactiveInferenceReliabilityEngine.js';
import { ProactiveVeracityJudgeService } from '../../legendary-arbitrage-syndicate/packages/@syndicate/core/src/prevention/ProactiveVeracityJudgeService.js';
import { SFTFlywheelGovernor } from '../../legendary-arbitrage-syndicate/packages/@syndicate/core/src/prevention/SFTFlywheelGovernor.js';

/**
 * üåê SOVEREIGN BROWSER SERVICE
 * ENHANCED with SPECIALIZED BROWSER Formal Reasoning & Proactive Prevention
 * ============================
 */
class BrowserService {
    constructor() {
        this.browser = null;
        this.contextEngine = null; // üí° Will be injected by the factory
        this.sharedMemory = null; // üí° Will be injected by the factory
        
        // üß† FORMAL REASONING & VERIFICATION SYSTEMS (BROWSER SERVICE SPECIALIZED)
        this.browserServiceFormalReasoning = null;        // Browser service formal reasoning coordinator
        
        // üõ°Ô∏è PROACTIVE PREVENTION SYSTEMS (BROWSER SERVICE SPECIALIZED)  
        this.browserServiceCredibilityPipeline = null;   // Browser service credibility validation
        this.browserServiceInferenceReliability = null;  // Browser service inference reliability
        this.browserServiceVeracityJudge = null;         // Browser service truth-over-profit evaluation
        this.browserServiceSFTGovernor = null;           // Browser service training data governance
        
        // Initialize integrations
        this.initializeBrowserServiceIntegrations();
    }

    setContextEngine(engine) {
        this.contextEngine = engine;
    }

    setSharedMemory(memory) {
        this.sharedMemory = memory;
    }
    
    async browseAndExtractText(url, agent) { // üí° Now requires the agent for context
        if (!this.browser) {
            console.error('‚ùå Cannot browse: Browser Service is not initialized.');
            return null;
        }
        if (!this.contextEngine) {
            console.error('‚ùå Cannot perform semantic extraction: ContextEngine not set.');
            // Fallback to naive innerText extraction
            const page = await this.browser.newPage();
            await page.goto(url, { waitUntil: 'networkidle2' });
            const text = await page.evaluate(() => document.body.innerText);
            await page.close();
            return text;
        }

        let page = null;
        try {
            page = await this.browser.newPage();
            await page.goto(url, { waitUntil: 'networkidle2', timeout: 60000 });
            
            const bodyHtml = await page.evaluate(() => document.body.innerHTML);

            // üí° STEP 1: Define the task objective for the Context Engine.
            const taskObjective = `Extract the core semantic content from the provided HTML of the webpage at ${url}.`;
            const taskSpecificData = { rawHtml: bodyHtml.substring(0, 40000) };

            // üí° STEP 2: Delegate context assembly to the ContextEngine.
            const context = await this.contextEngine.buildContext(agent, taskObjective, taskSpecificData);

            // üí° STEP 3: Create the final, context-aware prompt.
            const finalPrompt = `
${context}
---
**Final Instruction:**
Based on all the context provided, including the raw HTML, perform your expert data extraction. Ignore all boilerplate and return only the main title and clean, core content of the article in the specified JSON format.
`;

            const llmResponse = await ollamaIntegration.generate({
                model: process.env.LOCAL_REASONING_MODEL || 'llama3.1:70b',
                prompt: finalPrompt,
                format: 'json'
            });

            const extractedData = JSON.parse(llmResponse.response);
            
            console.log(`[Browser] Semantically extracted content via ContextEngine from ${url}.`);

            // üí° NEW: Write the extracted intelligence to the SharedMemorySystem
            if (this.sharedMemory) {
                this.sharedMemory.writeMemory({
                    type: 'web_content',
                    source: 'BrowserService',
                    authorAgentId: agent.id, // Associate the memory with the requesting agent
                    content: `Content extracted from ${url}: ${extractedData.mainContent}`,
                    metadata: {
                        url,
                        title: extractedData.title,
                        extractedAt: new Date().toISOString()
                    },
                    priority: 'medium'
                });
            }

            return extractedData.mainContent;

        } catch (error) {
            console.error(`‚ùå Failed to browse or extract content from ${url}:`, error.message);
            return null;
        } finally {
            if (page) {
                await page.close();
            }
        }
    }
    
    // ‚ùå REMOVED: buildExtractionPrompt. This is now handled by the ContextEngine.

    async initialize() {
        console.log('üåê Initializing Sovereign Browser Service...');
        try {
            // Launch a persistent browser instance. In a production system,
            // you might manage a pool of browser instances.
            this.browser = await puppeteer.launch({
                headless: true,
                args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            console.log('‚úÖ Browser Service operational.');
        } catch (error) {
            console.error('‚ùå CRITICAL: Failed to launch headless browser instance.', error);
            this.browser = null;
        }
    }

    async shutdown() {
        if (this.browser) {
            await this.browser.close();
            this.browser = null;
            console.log('üåê Browser Service shut down gracefully.');
        }
    }

    /**
     * üöÄ INITIALIZE BROWSER SERVICE INTEGRATIONS
     */
    async initializeBrowserServiceIntegrations() {
        await this.initializeBrowserServiceFormalReasoningIntegration();
        await this.initializeBrowserServiceProactivePreventionIntegration();
    }

    /**
     * üß† INITIALIZE BROWSER SERVICE FORMAL REASONING INTEGRATION (SPECIALIZED)
     * =======================================================================
     * 
     * SPECIALIZED INTEGRATION for Browser Service
     * Provides formal verification for web browsing algorithms and data extraction
     */
    async initializeBrowserServiceFormalReasoningIntegration() {
        console.log('üåê Initializing Browser Service Formal Reasoning Integration...');
        
        try {
            // Initialize browser service specialized formal reasoning
            this.browserServiceFormalReasoning = new FormalReasoningCognitiveIntegration({
                agentId: 'browser-service-formal',
                enablePersistence: true,
                browserServiceMode: true,
                coordinateBrowserServiceOperations: true
            });
            
            await this.browserServiceFormalReasoning.initialize();
            
            // Register Browser Service with specialized verification
            await this.browserServiceFormalReasoning.registerLearningSystemForFormalVerification('browser_service', {
                systemType: 'web_browsing_data_extraction',
                capabilities: [
                    'sovereign_web_browsing',
                    'headless_chromium_control',
                    'web_scraping_extraction',
                    'page_interaction_automation',
                    'article_content_reading',
                    'programmatic_web_navigation',
                    'data_extraction_validation'
                ],
                requiresVerification: [
                    'web_browsing_algorithms',
                    'data_extraction_procedures',
                    'scraping_accuracy_validation',
                    'page_interaction_reliability',
                    'content_reading_precision',
                    'navigation_safety_checks',
                    'extraction_validity_verification'
                ]
            });
            
            console.log('‚úÖ Browser Service Formal Reasoning Integration initialized');
            console.log('üåê Web browsing operations now have mathematical safety guarantees');
            
        } catch (error) {
            console.error('‚ùå Failed to initialize browser service formal reasoning:', error);
        }
    }

    /**
     * üõ°Ô∏è INITIALIZE BROWSER SERVICE PROACTIVE PREVENTION INTEGRATION (SPECIALIZED)
     * ============================================================================
     * 
     * SPECIALIZED INTEGRATION for Browser Service
     * Prevents web browsing hallucinations and ensures elite extraction quality
     */
    async initializeBrowserServiceProactivePreventionIntegration() {
        console.log('üõ°Ô∏è Initializing Browser Service Proactive Prevention Integration...');
        
        try {
            // Initialize browser service credibility pipeline
            this.browserServiceCredibilityPipeline = new ProactiveKnowledgeCredibilityPipeline({
                agentId: 'browser-service-credibility',
                enablePersistence: true,
                browserServiceMode: true,
                validateBrowserServiceData: true
            });
            
            // Initialize browser service inference reliability
            this.browserServiceInferenceReliability = new ProactiveInferenceReliabilityEngine({
                agentId: 'browser-service-inference',
                enablePersistence: true,
                browserServiceMode: true,
                memoryConsultationMandatory: false, // Fast web operations
                browserServiceAwareReasoning: true
            });
            
            // Initialize browser service veracity judge
            this.browserServiceVeracityJudge = new ProactiveVeracityJudgeService({
                agentId: 'browser-service-veracity',
                enablePersistence: true,
                browserServiceMode: true,
                truthOverProfitPriority: true,
                evaluateBrowserServiceResults: true
            });
            
            // Initialize browser service SFT governor
            this.browserServiceSFTGovernor = new SFTFlywheelGovernor({
                agentId: 'browser-service-sft',
                enablePersistence: true,
                browserServiceMode: true,
                governBrowserServiceData: true
            });
            
            // Initialize all browser service coordinators
            await Promise.all([
                this.browserServiceCredibilityPipeline.initialize(),
                this.browserServiceInferenceReliability.initialize(),
                this.browserServiceVeracityJudge.initialize(),
                this.browserServiceSFTGovernor.initialize()
            ]);
            
            console.log('‚úÖ Browser Service Proactive Prevention Integration initialized');
            console.log('üõ°Ô∏è Browser service now immune to web extraction hallucinations');
            console.log('üåä Web browsing data credibility validation: ACTIVE');
            console.log('üîÑ Web extraction quality governance: ACTIVE');
            console.log('‚öñÔ∏è Truth-over-profit for web browsing: ACTIVE');
            console.log('üí® Web operations bypass memory consultation for performance');
            
        } catch (error) {
            console.error('‚ùå Failed to initialize browser service proactive prevention:', error);
        }
    }
}

const browserService = new BrowserService();

export { BrowserService, browserService };
