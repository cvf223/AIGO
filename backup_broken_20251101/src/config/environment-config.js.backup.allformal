/**
 * üåç ENVIRONMENT CONFIGURATION
 * ============================
 * 
 * Centralized environment detection and configuration
 * for enabling/disabling features based on environment.
 * 
 * TOP 1% IMPLEMENTATION - Production Ready!
 */

import os from 'os';

export class EnvironmentConfig {
    constructor() {
        // Detect environment
        this.env = process.env.NODE_ENV || 'development';
        this.isDevelopment = this.env === 'development';
        this.isProduction = this.env === 'production';
        // üéØ SUPERIOR PRODUCTION DETECTION: 896GB server is CLEARLY production!
        // Auto-detect production based on server specs
        const isHighSpecServer = this.totalMemoryGB >= 64; // 64GB+ = production server
        const hasProductionIndicators = (
            this.totalMemoryGB >= 800 || // 800GB+ is definitely production
            process.env.HOME?.includes('root') || // Running as root often indicates production
            process.env.PWD?.includes('LocalBackup') // Production deployment path
        );
        
        // Override environment detection for high-spec servers
        if (isHighSpecServer || hasProductionIndicators) {
            console.log('üéØ DETECTED: High-spec production server (overriding NODE_ENV)');
            this.env = 'production';
            this.isDevelopment = false;
            this.isProduction = true;
        }
        
        // Detect available resources
        this.totalMemoryGB = Math.floor(os.totalmem() / (1024 * 1024 * 1024));
        this.isLowMemory = this.totalMemoryGB < 16;  // Less than 16GB considered low
        
        // Feature flags based on environment
        this.features = {
            // LLM/OLLAMA features
            ollama: {
                enabled: !this.isDevelopment && !this.isLowMemory,
                autoStart: this.isProduction && this.totalMemoryGB >= 32,
                fallbackToMock: this.isDevelopment
            },
            
            // Data collection
            dataCollection: {
                enabled: true,  // Always enabled
                nonLLMCollectorEnabled: true,  // Always collect non-LLM data
                saveInterval: this.isDevelopment ? 60000 : 30000  // 1 min dev, 30s prod
            },
            
            // Quantum features
            quantum: {
                enabled: true,
                requiresVerification: true,
                minCorroborationSources: this.isDevelopment ? 2 : 4  // Relax in dev
            },
            
            // Database
            database: {
                maxConnections: this.isDevelopment ? 10 : 50,
                connectionTimeout: this.isDevelopment ? 10000 : 5000,
                retryAttempts: this.isDevelopment ? 2 : 5
            }
        };
        
        console.log(`üåç Environment: ${this.env}`);
        console.log(`üíæ Memory: ${this.totalMemoryGB}GB`);
        console.log(`ü§ñ OLLAMA: ${this.features.ollama.enabled ? 'ENABLED' : 'DISABLED'}`);
    }
    
    /**
     * Check if a feature should be enabled
     */
    isFeatureEnabled(feature) {
        const parts = feature.split('.');
        let current = this.features;
        
        for (const part of parts) {
            if (current[part] === undefined) return false;
            current = current[part];
        }
        
        return current === true || (typeof current === 'object' && current.enabled);
    }
    
    /**
     * Get feature configuration
     */
    getFeatureConfig(feature) {
        const parts = feature.split('.');
        let current = this.features;
        
        for (const part of parts) {
            if (current[part] === undefined) return null;
            current = current[part];
        }
        
        return current;
    }
    
    /**
     * Override features for testing
     */
    override(overrides) {
        Object.assign(this.features, overrides);
    }
}

// Export singleton
export const environmentConfig = new EnvironmentConfig();
